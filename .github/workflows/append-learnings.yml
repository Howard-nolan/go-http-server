name: Append Learnings
on:
  pull_request:
    types: [closed]

jobs:
  append:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - uses: actions/checkout@v4

      - name: Build learnings entry from PR body
        id: build
        uses: actions/github-script@v7
        with:
          script: |
            // Helpers
            function section(name, body) {
              // Match "## Name:" OR "Name:" (case-insensitive), capture until blank line or end
              const re = new RegExp(`(?:^|\\n)##?\\s*${name}\\s*:\\s*([\\s\\S]*?)(?:\\n\\s*\\n|$)`, 'i');
              const m = body.match(re);
              return m ? m[1].trim() : '';
            }
            function mdClean(s) {
              // Normalize Windows newlines, trim trailing spaces
              return s.replace(/\r/g, '').trim();
            }

            const pr = context.payload.pull_request;
            const body = pr.body || '';

            const changeSummary = mdClean(section('Change Summary', body));
            const howItWorks   = mdClean(section('How It Works', body));
            const notes        = mdClean(section('Additional Notes', body));

            // If everything is empty, do nothing
            if (!changeSummary && !howItWorks && !notes) {
              core.setOutput('should_update', 'false');
              return;
            }

            const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
            const header = `## ${today} - PR #${pr.number}: ${pr.title}`;

            let entry = `${header}\n\n`;
            if (changeSummary) entry += `**Change Summary**\n${changeSummary}\n\n`;
            if (howItWorks)   entry += `**How It Works**\n${howItWorks}\n\n`;
            if (notes)        entry += `**Additional Notes**\n${notes}\n\n`;

            core.setOutput('should_update', 'true');
            core.setOutput('entry', entry);

      - name: Append to LEARNINGS.md
        if: steps.build.outputs.should_update == 'true'
        run: |
          touch LEARNINGS.md
          printf "\n%s" "${{ steps.build.outputs.entry }}" >> LEARNINGS.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add LEARNINGS.md
          git commit -m "docs: append learnings from PR #${{ github.event.pull_request.number }}"
          git push